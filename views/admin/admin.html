<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Banque</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: #2c3e50;
      color: white;
      min-height: 100vh;
      padding: 30px 20px;
    }

    .sidebar h2 {
      font-size: 22px;
      margin-bottom: 30px;
    }

    .sidebar a {
      display: block;
      color: white;
      margin-bottom: 15px;
      text-decoration: none;
    }

    .sidebar a:hover {
      color: #1abc9c;
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 40px;
    }

    .header {
      margin-bottom: 30px;
    }

    .stat-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .card-stat {
      flex: 1;
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }

    .card-stat h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #7f8c8d;
    }

    .card-stat .value {
      font-size: 28px;
      font-weight: bold;
    }

    /* Form & Table */
    .admin-section {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .form-group label {
      margin-top: 10px;
      font-weight: 500;
    }

    button {
      margin-top: 15px;
    }

    table {
      margin-top: 30px;
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 12px;
    }

    table th {
      background-color: #f0f0f0;
    }

    .btn-danger {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
    }

    .success-message, .error-message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      display: none;
    }

    .success-message {
      background-color: #dff0d8;
      color: #3c763d;
    }

    .error-message {
      background-color: #f2dede;
      color: #a94442;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>üè¶ Banque</h2>
    
    <!-- Informations utilisateur -->
    <div style="background-color: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 20px;">
      <small style="opacity: 0.8;">Connect√© en tant que:</small>
      <div id="user-info" style="font-weight: bold; margin-top: 5px;">
        üë§ Administrateur
      </div>
    </div>

    <!-- <a href="../../index.html"><i class="bi bi-house"></i> Accueil</a> -->
    <!-- <a href="../client.html"><i class="bi bi-person"></i> Interface Client</a> -->
    <!-- <a href="../agent.html"><i class="bi bi-briefcase"></i> Interface Agent</a> -->
    <!-- <a href="#" class="active"><i class="bi bi-gear"></i> Administration</a> -->
    
    <!-- Bouton de d√©connexion -->
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
      <a href="#" onclick="seDeconnecter()" style="color: #e74c3c; background-color: rgba(231,76,60,0.1); padding: 10px; border-radius: 6px; text-align: center;">
        <i class="bi bi-box-arrow-right"></i> D√©connexion
      </a>
    </div>
  </div>

  <!-- Main content -->
  <div class="main">
    <div class="header">
      <h1 class="fw-bold">Dashboard Administration</h1>
      <p class="text-muted">Gestion des types de pr√™ts</p>
    </div>

    <div class="stat-cards">
      <div class="card-stat">
        <h3>Types de pr√™ts</h3>
        <div class="value" id="total-types">0</div>
      </div>
      <div class="card-stat">
        <h3>Clients</h3>
        <div class="value" id="total-clients">0</div>
      </div>
      <div class="card-stat">
        <h3>Pr√™ts en cours</h3>
        <div class="value" id="total-prets">0</div>
      </div>
    </div>

    <div class="admin-section">
      <h2 class="mb-3">üìã Gestion des Types de Pr√™t</h2>

      <div class="success-message" id="success-message"></div>
      <div class="error-message" id="error-message"></div>

      <!-- Formulaire -->
      <form id="form-type-pret" onsubmit="return false;">
        <div class="form-group">
          <label for="nom_type">Nom du type de pr√™t :</label>
          <input type="text" id="nom_type" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="taux">Taux d'int√©r√™t (%) :</label>
          <input type="number" step="0.01" min="0" max="50" id="taux" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="duree">Dur√©e en mois :</label>
          <input type="number" min="1" max="600" id="duree" class="form-control" required>
        </div>

        <button type="button" onclick="ajouterTypePret()" class="btn btn-success">
          ‚ûï Ajouter le type de pr√™t
        </button>
      </form>

      <!-- Tableau -->
      <table class="table mt-4">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom du pr√™t</th>
            <th>Taux (%)</th>
            <th>Dur√©e (mois)</th>
            <th>Dur√©e (ann√©es)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="table-type-pret">
          <tr>
            <td colspan="6" class="text-center text-muted">Chargement des donn√©es...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost/projet_final/ws";

    // Fonctions utilitaires pour les messages
    function afficherMessage(message, type = 'success') {
      const messageEl = document.getElementById(type + '-message');
      messageEl.textContent = message;
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }

    function masquerMessages() {
      document.getElementById('success-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    // Charger les statistiques
    function chargerStatistiques() {
      // Compter les types de pr√™ts
      fetch(apiBase + "/typepret")
        .then(res => res.json())
        .then(data => {
          document.getElementById('total-types').textContent = data.length;
        })
        .catch(() => {
          document.getElementById('total-types').textContent = '?';
        });

      // Compter les clients
      fetch(apiBase + "/clients")
        .then(res => res.json())
        .then(data => {
          document.getElementById('total-clients').textContent = data.length;
        })
        .catch(() => {
          document.getElementById('total-clients').textContent = '?';
        });

      // Compter les pr√™ts
      fetch(apiBase + "/prets")
        .then(res => res.json())
        .then(data => {
          document.getElementById('total-prets').textContent = data.length;
        })
        .catch(() => {
          document.getElementById('total-prets').textContent = '?';
        });
    }

    function chargerTypesPret() {
      fetch(apiBase + "/typepret")
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("table-type-pret");
          tbody.innerHTML = "";
          
          if (data.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; color: #7f8c8d;">
                  Aucun type de pr√™t configur√©
                </td>
              </tr>
            `;
            return;
          }

          data.forEach(tp => {
            const row = document.createElement("tr");
            const dureeAnnees = Math.round(tp.duree_mois / 12 * 10) / 10; // Arrondi √† 1 d√©cimale
            
            row.innerHTML = `
              <td>${tp.id}</td>
              <td><strong>${tp.nom}</strong></td>
              <td>${tp.taux_interet}%</td>
              <td>${tp.duree_mois}</td>
              <td>${dureeAnnees} ${dureeAnnees > 1 ? 'ans' : 'an'}</td>
              <td>
                <button class="btn-danger" onclick="supprimerTypePret(${tp.id})">
                  üóëÔ∏è Supprimer
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Erreur:', error);
          const tbody = document.getElementById("table-type-pret");
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; color: #e74c3c;">
                Erreur lors du chargement des donn√©es
              </td>
            </tr>
          `;
        });
    }

    function ajouterTypePret() {
      masquerMessages();
      
      const nom = document.getElementById("nom_type").value.trim();
      const taux = document.getElementById("taux").value;
      const duree = document.getElementById("duree").value;

      // Validation
      if (!nom || !taux || !duree) {
        afficherMessage('Veuillez remplir tous les champs', 'error');
        return;
      }

      if (parseFloat(taux) < 0 || parseFloat(taux) > 50) {
        afficherMessage('Le taux doit √™tre entre 0 et 50%', 'error');
        return;
      }

      if (parseInt(duree) < 1 || parseInt(duree) > 600) {
        afficherMessage('La dur√©e doit √™tre entre 1 et 600 mois', 'error');
        return;
      }

      const data = {
        nom: nom,
        taux_interet: parseFloat(taux),
        duree_mois: parseInt(duree)
      };

      fetch(apiBase + "/typepret", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        if (response.error) {
          afficherMessage('Erreur: ' + response.error, 'error');
        } else {
          afficherMessage(`Type de pr√™t "${nom}" ajout√© avec succ√®s!`, 'success');
          
          // R√©initialiser le formulaire
          document.getElementById("nom_type").value = "";
          document.getElementById("taux").value = "";
          document.getElementById("duree").value = "";
          
          // Recharger les donn√©es
          chargerTypesPret();
          chargerStatistiques();
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        afficherMessage('Erreur lors de l\'ajout du type de pr√™t', 'error');
      });
    }

    function supprimerTypePret(id) {
      if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce type de pr√™t ?\n\nCette action est irr√©versible.")) {
        return;
      }

      fetch(apiBase + `/typepret/${id}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(response => {
        if (response.error) {
          afficherMessage('Erreur: ' + response.error, 'error');
        } else {
          afficherMessage('Type de pr√™t supprim√© avec succ√®s', 'success');
          chargerTypesPret();
          chargerStatistiques();
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        afficherMessage('Erreur lors de la suppression', 'error');
      });
    }

    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function() {
      // V√©rifier l'authentification au chargement
      const utilisateur = sessionStorage.getItem('utilisateur');
      
      if (!utilisateur) {
        afficherMessage('Vous devez √™tre connect√© pour acc√©der √† cette page', 'error');
        setTimeout(() => {
          window.location.href = '../connexion_admin.html';
        }, 2000);
        return;
      }

      const userData = JSON.parse(utilisateur);
      
      // V√©rifier le r√¥le
      if (userData.role !== 'admin') {
        afficherMessage('Acc√®s non autoris√© pour ce type de compte', 'error');
        setTimeout(() => {
          window.location.href = '../../index.html';
        }, 2000);
        return;
      }

      // Afficher les informations de l'administrateur
      document.getElementById('user-info').innerHTML = `üë§ ${userData.nom || userData.email}`;
      
      // Charger les donn√©es
      chargerTypesPret();
      chargerStatistiques();
    });

    // Fonction de d√©connexion
    function seDeconnecter() {
      if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        sessionStorage.removeItem('utilisateur');
        afficherMessage('D√©connexion r√©ussie', 'success');
        setTimeout(() => {
          window.location.href = '../../index.html';
        }, 1500);
      }
    }

    // Session timeout (30 minutes pour admin)
    let inactivityTimer;
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        sessionStorage.removeItem('utilisateur');
        alert('Session expir√©e pour des raisons de s√©curit√©');
        window.location.href = '../connexion_admin.html';
      }, 30 * 60 * 1000); // 30 minutes
    }

    // R√©initialiser le timer sur activit√©
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('click', resetInactivityTimer);
    resetInactivityTimer(); // D√©marrer le timer

    // Permettre la soumission du formulaire avec Enter
    document.getElementById('duree').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        ajouterTypePret();
      }
    });
  </script>
</body>
</html>
