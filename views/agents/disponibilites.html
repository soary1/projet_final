<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Disponibilités Mensuelles - EF Mada</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="flex bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 p-6 bg-[#1e2a56] text-white flex flex-col space-y-4">
    <h2 class="text-2xl font-bold text-blue-300 mb-6">EF Mada</h2>
    <a href="pres/liste_prets.html" class="flex items-center gap-2 hover:bg-blue-800 p-2 rounded-md"><i class="bi bi-list"></i> Voir les prêts</a>
    <a href="pres/prets-attente.html" class="flex items-center gap-2 hover:bg-blue-800 p-2 rounded-md"><i class="bi bi-hourglass-split"></i> Prêts en attente</a>
    <a href="fond.php" class="flex items-center gap-2 hover:bg-blue-800 p-2 rounded-md"><i class="bi bi-cash-stack"></i> Ajouter un fond</a>
    <a href="simulation.php" class="flex items-center gap-2 hover:bg-blue-800 p-2 rounded-md"><i class="bi bi-calculator"></i> Simulation Prêt</a>
    <a href="interet.php" class="flex items-center gap-2 hover:bg-blue-800 p-2 rounded-md"><i class="bi bi-bar-chart"></i> Intérêt</a>
    <a href="disponibilites.html" class="flex items-center gap-2 bg-blue-800 p-2 rounded-md"><i class="bi bi-calendar3"></i> Disponibilités</a>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Disponibilité mensuelle de l'établissement</h1>

    <form id="filtre-form" class="glass rounded-xl p-6 shadow-md mb-6 flex gap-4 items-end">
      <div>
        <label for="debut" class="block text-sm font-medium text-gray-700">Mois de début</label>
        <input type="month" id="debut" name="debut" class="mt-1 p-2 border rounded-md w-full" required />
      </div>
      <div>
        <label for="fin" class="block text-sm font-medium text-gray-700">Mois de fin</label>
        <input type="month" id="fin" name="fin" class="mt-1 p-2 border rounded-md w-full" required />
      </div>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">Filtrer</button>
    </form>

    <div class="glass p-6 rounded-2xl shadow-lg">
      <table class="w-full text-center text-sm text-gray-700">
        <thead class="bg-white bg-opacity-50 font-semibold text-gray-800">
          <tr>
            <th class="py-3">Mois</th>
            <th class="py-3">Fonds reçus</th>
            <th class="py-3">Montants empruntés</th>
            <th class="py-3">Remboursements</th>
            <th class="py-3">Disponible</th>
          </tr>
        </thead>
        <tbody id="table-body" class="bg-white bg-opacity-40">
          <!-- Data insérée ici -->
        </tbody>
      </table>
    </div>

    <div class="glass p-6 mt-8 rounded-2xl shadow-lg">
      <canvas id="dispoChart" height="100"></canvas>
    </div>
  </main>

  <script>
  const apiBase = "http://localhost/projet_final/ws";

  const form = document.getElementById("filtre-form");
  const tableBody = document.getElementById("table-body");
  const ctx = document.getElementById("dispoChart").getContext("2d");
  let chart;

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const debut = document.getElementById("debut").value;
    const fin = document.getElementById("fin").value;

    if (!debut || !fin) return;

    fetch(`${apiBase}/disponibilites?debut=${debut}&fin=${fin}`)
      .then(res => res.json())
      .then(data => {
        tableBody.innerHTML = "";
        const labels = [];
        const fonds = [];
        const empruntes = [];
        const remboursements = [];
        const disponibles = [];

        data.forEach(item => {
          labels.push(item.mois);
          fonds.push(item.fonds);
          empruntes.push(item.montants_empruntes);
          remboursements.push(item.remboursements);
          disponibles.push(item.disponible);

          const row = `<tr>
            <td class="py-2">${item.mois}</td>
            <td class="py-2">${item.fonds.toLocaleString()} Ar</td>
            <td class="py-2">${item.montants_empruntes.toLocaleString()} Ar</td>
            <td class="py-2">${item.remboursements.toLocaleString()} Ar</td>
            <td class="py-2 font-semibold">${item.disponible.toLocaleString()} Ar</td>
          </tr>`;
          tableBody.innerHTML += row;
        });

        // Rafraîchir le graphique
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Fonds disponibles',
                data: fonds,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.4
              },
              {
                label: 'Montants empruntés',
                data: empruntes,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                tension: 0.4
              },
              {
                label: 'Remboursements',
                data: remboursements,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.4
              },
              {
                label: 'Disponibilité finale',
                data: disponibles,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      });
  });
</script>


</body>
</html>
